大家好，我是牛牛。从业多年，有参加过面试，有面试过别人，经历过的面试不下百场。在字节跳动的时候，作为资深面试官，深度参与校招和社招。

很多人问我，面试到底考察什么？面试官究竟想听到怎样的回答？针对这类疑惑，我觉得最好的解答，无疑是带着大家，以面试官视角，去进行面试，知己知彼，百战不殆，这就是我写这个系列的初衷。

话不多说，接下来就来看看我们面试官系列的第一弹吧！

这次我们的面试主题是Redis，我一般要考察的知识点都在下图，根据候选人的情况，会选择不同的知识点进行提问。
<center>
  
![](https://files.mdnice.com/user/13621/6af1cc1e-c197-40d5-a3e4-55138a6534bd.png)</center>

通过上图，大家对Redis面试问题也心里有数了吧？

现在，就让我们来体验一场沉浸式面试，牛牛担任恶魔面试官，友情请来阿柴担任面试者。

今天，我们就先来打打基础，讲讲Redis的基础和数据结构。

准备好了么？Let's go！
<center>
  
![](https://mmbiz.qpic.cn/mmbiz_gif/HQKXnkPzzdvvEYV0pQJLR0yBS9s1icGbTw11Z9yhR62f9wKapMxVBLiaibIibyCgTYVfbBLiaSwiaulI1CMbSS2DH9YQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)</center>


## PART1 基础摸底
一般情况下，面试官不会上来就问难度颇高的问题，都是随着知识点循序渐进，校招更是遵从这样的引导思路。所以，考察面试者都是从基础知识入手，Redis当然也不例外。

🐮:<b>你知道Redis是什么吗？</b>

🐶:Redis是一个数据库，不过与传统RDBM不同，Redis属于NoSQL，也就是非关系型数据库，它的存储结构是Key-Value。Redis的数据直接存在内存中，读写速度非常快，因此Redis被广泛应用于缓存方向。

🐮:<b>那NoSQL的BASE理论是什么？</b>

🐶:可以说BASE理论是CAP中一致性的妥协。和传统事务的ACID截然不同，BASE不追求强一致性，而是允许数据在一段时间内是不一致的，但最终达到一致状态，从而获得更高的可用性和性能。
<center>
  
![](https://files.mdnice.com/user/13621/15955cfb-8722-40ae-bf66-d2566de5a6ce.png)</center>

🐮:<b>先说说你最常用的Redis命令吧？</b>

🐶:我最常用的读操作是get a，表示获取a对应的数据；最常用的写操作是setex a t b，表示将a的数据设置为b，并且在t秒后过期。

🐮:<b>你提到了过期时间，那你知道Redis的过期键清除策略吗？</b>

🐶:过期键清除策略有三种，分别是定时删除、定期删除和惰性删除。

🐶:<font color=Blue>定时删除</font>，是在设置键的过期时间的同时，创建一个定时器，让定时器在键的过期时间来临时，立即执行对键的删除操作;

🐶:<font color=Blue>定期删除</font>，每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键；

🐶:<font color=Blue>惰性删除</font>，是指使用的时候，发现Key过期了，此时再进行删除。

🐶:<b><font color=Blue>Redis过期键采用的是定期删除+惰性删除二者结合</font></b>的方式进行删除的。
<center>
  
![](https://files.mdnice.com/user/13621/ac1e33d0-0566-4d3e-a939-6f354d50cdc2.png)</center>

🐮:<b>如果过期键没有被访问，而周期性删除又跟不上新键产生的速度，内存不就慢慢耗尽了吗？</b>

🐶:Redis支持内存淘汰，配置参数maxmemory_policy决定了内存淘汰策略的策略。这个参数一共有8个枚举值。

![](https://files.mdnice.com/user/13621/983e9d03-2c14-4e9c-a75b-ec034e480513.png)

🐮:<b>内存淘汰用到的是LRU算法吗？</b>

🐶:嗯...Redis用的是<b><font color=Blue>近似LRU算法</font></b>，LRU算法需要一个双向链表来记录数据的最近被访问顺序，但是出于节省内存的考虑，Redis的LRU算法并非完整的实现。

🐶:Redis通过对少量键进行取样，然后和目前维持的淘汰池综合比较，回收其中的最久未被访问的键。通过调整每次回收时的采样数量maxmemory-samples，可以实现调整算法的精度。

显然，面试官开门见山，摸了下阿柴的基础，并进行了一定程度的发散。看得出来，阿柴基础扎实，有备而来，是时候探探他的真本事了。




## PART2 数据结构

🐮:<b>你知道Redis有多少数据结构吗？</b>

🐶:对外暴露5种Redis对象，分别是String、List、Hash、Set、Zset。底层实现依托于sds、ziplist、skiplist、dict等更基础数据结构。

![](https://files.mdnice.com/user/13621/2f0f6d48-7a86-409c-9fa5-a86897facd2d.png)

不错，知道得很清楚，能区分对外结构和底层实现。那么下面就针对几个结构，来重点追问下。

🐮:<b>那Redis字符串有什么特点？</b>

🐶:Redis的字符串如果保存的对象是整数类型，那么就用int存储。如果不能用整数表示，就用SDS来表示，SDS通过记录长度，和预分配空间，可以高效计算长度，进行append操作。

![](https://files.mdnice.com/user/13621/89847777-7c1c-4de6-85ce-22948636f491.png)

嗯，能说清楚SDS就达到了面试官的预期，如果能根据不同数据类型讲清楚，加分！

🐮:<b>Hash扩容过程是怎样的？</b>

🐶:两张Hash表，平常起作用的都是0号表，当装载因子超过阈值时就会进行Rehash，将0号每上每一个bucket慢慢移动到1号表，所以叫渐进式Rehash，这种方式可以减少迁移系统的影响。

🐮:<b>慢慢移动？能详细说下Rehash过程吗？</b>

🐶:当周期函数发现为装载因子超过阈值时就会进行Rehash。Rehash的流程大概分成三步。

🐶:<font color=Blue>首先，生成新Hash表ht[1]，为 ht[1] 分配空间。</font>此时字典同时持有ht[0]和ht[1]两个哈希表。字典的偏移索引从静默状态-1，设置为0，表示Rehash 工作正式开始。

🐶:<font color=Blue>然后，迁移ht[0]数据到ht[1]。</font>在 Rehash进行期间，每次对字典执行增删查改操作，程序会顺带迁移一个ht[0]上的数据，并更新偏移索引。与此同时，周期函数也会定时迁移一批。

🐶:<font color=Blue>最后，ht[1]和ht[0]指针对象交换。</font>随着字典操作的不断执行， 最终在某个时间点上，ht[0]的所有键值对都会被Rehash至 ht[1]，此时再将ht[1]和ht[0]指针对象互换，同时把偏移索引的值设为-1，表示Rehash操作已完成。

![](https://files.mdnice.com/user/13621/5566c59d-be14-4145-8e2d-fe6521dfed6a.png)

🐮:<b>如果字典正在Rehash，此时有请求过来，Redis会怎么处理？</b>

🐶:针对新增Key，是往ht[1]里面插入。针对读请求，先从ht[0]读，没找到再去ht[1]找。至于删除和更新，其实本质是先找到位置，再进行操作，所以和读请求一样，先找ht[0]，再找ht[1]，找到之后再进行操作。

🐮:<b>接下来讲讲跳表的实现吧。</b>

🐶:跳表本质上是对链表的一种优化，通过逐层跳步采样的方式构建索引，以加快查找速度。如果只用普通链表，只能一个一个往后找。跳表就不一样了，可以高层索引，一次跳跃多个节点，如果找过头了，就用更下层的索引。

![](https://files.mdnice.com/user/13621/44a5c8e0-6905-472d-94d6-f8af8031b370.png)

🐮:<b>那每个节点有多少层呢？</b>

🐶:<font color=Blue>使用概率均衡的思路</font>，确定新插入节点的层数。Redis使用随机函数决定层数。直观上来说，默认1层，和丢硬币一样，如果是正面就继续往上，这样持续迭代，最大层数32层。

🐶:可以看到，50%的概率被分配到第一层，25%的概率被分配到第二层，12.5%的概率被分配到第三层。这种方式保证了越上层数量越少，自然跨越起来越方便。
<center>

![](https://files.mdnice.com/user/13621/91d22c35-cbfd-4464-960f-854319c90cbc.png)</center>

跳表原理说清楚就达标，说出层次算法加分。

🐮:<b>Redis的Zset为什么同时需要字典和跳表来实现？</b>

🐶:Zset是一个有序列表，字典和跳表分别对应两种查询场景，<b><font color=Blue>字典用来支持按成员查询数据，跳表则用以实现高效的范围查询</font></b>，这样两个场景，性能都做到了极致。

Redis的数据结构包含了很多干货，在细节处见功夫，阿柴对答如流。面试官不由地更加期待他接下来的表现了。

### 牛牛复盘
Redis是后台开发的核心技术，是工作中的必备技能，更是面试中的超高频考点。本次我们聚焦于Redis的基础知识以及数据结构，文中的问题都是实实在在的面试真题，小伙伴们如果有不太理解的地方，一定要深入研究一下，也可以随时咨询牛牛哦，我们下期再见。
